name: regr-tests
on: [push]
jobs:
  # Standard variants (testsim + testms)
  run-regr-tests:
    runs-on: ubuntu-22.04
    strategy:
      fail-fast: false
      matrix:
        mbedtls-version: ['2.28.8', '3.6.0']
        test-category: ['core', 'tls-cups', 'updn', 'pps']
    name: ${{ matrix.test-category }} (mbedtls ${{ matrix.mbedtls-version }})
    steps:
      - name: Checkout repo
        uses: actions/checkout@v4
      - name: Setup environment
        run: |
          sudo apt-get install -y python3.11 python3-pip virtualenv psmisc git build-essential lcov curl netcat-openbsd python3-jsonschema python3-jinja2
          virtualenv --python python3.11 --system-site-packages pyenv
          . pyenv/bin/activate
          pip3 install setuptools aiohttp websockets
      - name: Build testsim and testms
        env:
          MBEDTLS_VERSION: ${{ matrix.mbedtls-version }}
        run: |
          make platform=linux variant=testsim
          make platform=linux variant=testms
      - name: Execute Tests (testsim)
        env:
          MBEDTLS_VERSION: ${{ matrix.mbedtls-version }}
        run: |
          . pyenv/bin/activate
          export PPSTHRES=100
          export TX_AIM_GAP='"40ms"'
          cd regr-tests && ./run-tests-${{ matrix.test-category }} --nohw --verbose --ghactions --nobuild --variant=testsim
      - name: Execute Tests (testms)
        env:
          MBEDTLS_VERSION: ${{ matrix.mbedtls-version }}
        run: |
          . pyenv/bin/activate
          export PPSTHRES=100
          export TX_AIM_GAP='"40ms"'
          cd regr-tests && ./run-tests-${{ matrix.test-category }} --nohw --verbose --ghactions --nobuild --variant=testms
      - name: Archive logs
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: logs-${{ matrix.test-category }}-mbedtls-${{ matrix.mbedtls-version }}
          path: regr-tests/t.log/**/*.log
      - name: Collect coverage files
        if: always()
        run: |
          mkdir -p regr-tests/coverage
          find regr-tests -name '*.info' -exec cp {} regr-tests/coverage/ \; 2>/dev/null || true
      - name: Upload coverage info
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: coverage-${{ matrix.test-category }}-mbedtls-${{ matrix.mbedtls-version }}
          path: regr-tests/coverage/

  # SX1302/1303 variants (testsim1302 + testms1302)
  run-regr-tests-1302:
    runs-on: ubuntu-22.04
    strategy:
      fail-fast: false
      matrix:
        mbedtls-version: ['2.28.8', '3.6.0']
        test-category: ['core', 'tls-cups', 'updn', 'pps']
    name: ${{ matrix.test-category }}-1302 (mbedtls ${{ matrix.mbedtls-version }})
    steps:
      - name: Checkout repo
        uses: actions/checkout@v4
      - name: Setup environment
        run: |
          sudo apt-get install -y python3.11 python3-pip virtualenv psmisc git build-essential lcov curl netcat-openbsd python3-jsonschema python3-jinja2
          virtualenv --python python3.11 --system-site-packages pyenv
          . pyenv/bin/activate
          pip3 install setuptools aiohttp websockets
      - name: Build testsim1302 and testms1302
        env:
          MBEDTLS_VERSION: ${{ matrix.mbedtls-version }}
        run: |
          make platform=linux variant=testsim1302
          make platform=linux variant=testms1302
      - name: Execute Tests (testsim1302)
        env:
          MBEDTLS_VERSION: ${{ matrix.mbedtls-version }}
        run: |
          . pyenv/bin/activate
          export PPSTHRES=100
          export TX_AIM_GAP='"40ms"'
          cd regr-tests && ./run-tests-${{ matrix.test-category }} --nohw --verbose --ghactions --nobuild --variant=testsim1302
      - name: Execute Tests (testms1302)
        env:
          MBEDTLS_VERSION: ${{ matrix.mbedtls-version }}
        run: |
          . pyenv/bin/activate
          export PPSTHRES=100
          export TX_AIM_GAP='"40ms"'
          cd regr-tests && ./run-tests-${{ matrix.test-category }} --nohw --verbose --ghactions --nobuild --variant=testms1302
      - name: Archive logs
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: logs-${{ matrix.test-category }}-1302-mbedtls-${{ matrix.mbedtls-version }}
          path: regr-tests/t.log/**/*.log
      - name: Collect coverage files
        if: always()
        run: |
          mkdir -p regr-tests/coverage
          find regr-tests -name '*.info' -exec cp {} regr-tests/coverage/ \; 2>/dev/null || true
      - name: Upload coverage info
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: coverage-${{ matrix.test-category }}-1302-mbedtls-${{ matrix.mbedtls-version }}
          path: regr-tests/coverage/

  # Combine coverage reports from all test jobs
  coverage-report:
    runs-on: ubuntu-22.04
    needs: [run-regr-tests, run-regr-tests-1302]
    if: always()
    name: Coverage Report
    steps:
      - name: Checkout repo
        uses: actions/checkout@v4
      - name: Setup lcov
        run: sudo apt-get install -y lcov
      - name: Download all coverage artifacts
        uses: actions/download-artifact@v4
        with:
          pattern: coverage-*
          path: coverage/
          merge-multiple: true
      - name: Merge coverage reports
        run: |
          info_files=$(find coverage -name '*.info' -type f 2>/dev/null)
          if [ -n "$info_files" ]; then
            lcov -t "s2core" $(for f in $info_files; do echo "-a $f"; done) -o s2core.info
            genhtml s2core.info -o s2core-html
          else
            echo "No coverage files found"
            mkdir -p s2core-html
            echo "No coverage data" > s2core-html/index.html
          fi
      - name: Upload combined coverage report
        uses: actions/upload-artifact@v4
        with:
          name: coverage-report
          path: s2core-html/
